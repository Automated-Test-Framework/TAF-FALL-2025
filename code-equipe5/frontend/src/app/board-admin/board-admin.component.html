<div class="page">
  <h2 class="page-title">Dashboard – {{ project }}</h2>

  <!-- KPI Cards -->
  <div class="kpis">
    <div class="kpi-card">
      <div class="kpi-title">Total runs ({{ days }} j)</div>
      <div class="kpi-value">{{ totalRuns | number }}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">Passés</div>
      <div class="kpi-value">{{ totalPassed | number }}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">Passrate global</div>
      <div class="kpi-value">{{ passPct }}%</div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters card">
    <div class="row">
      <div class="col">
        <label>Statut</label>
        <select [(ngModel)]="fStatus" (change)="loadAll()">
          <option value="all">Tous</option>
          <option value="passed">Passés</option>
          <option value="failed">Échoués</option>
        </select>
      </div>
      <div class="col">
        <label>Outil</label>
        <select [(ngModel)]="fTool" (change)="loadAll()">
          <option value="all">Tous</option>
          <option value="gatling">Gatling</option>
          <option value="selenium">Selenium</option>
          <option value="restAssured">Rest Assured</option>
          <option value="other">Autre</option>
        </select>
      </div>
      <div class="col">
        <label>Fenêtre</label>
        <div class="segmented">
          <button [class.active]="days===7"  (click)="days=7;  loadAll()">7 j</button>
          <button [class.active]="days===14" (click)="days=14; loadAll()">14 j</button>
          <button [class.active]="days===30" (click)="days=30; loadAll()">30 j</button>
          <button [class.active]="days===60" (click)="days=60; loadAll()">60 j</button>
        </div>
      </div>
      <div class="col right">
        <button class="primary" (click)="loadAll()">Appliquer</button>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="card">
      <h3>Répartition (pass/échec)</h3>
      <div *ngIf="loadingRate" class="skeleton chart"></div>
      <div class="pie-wrap" *ngIf="!loadingRate">
        <canvas
          baseChart
          [data]="pieData"
          [options]="pieOptions"
          chartType="doughnut">
        </canvas>
        <div class="pie-center">{{ passPct }}%</div>
      </div>
      <div class="legend-inline">
        <span class="dot pass"></span> Passés
        <span class="dot fail"></span> Échoués
      </div>
    </div>

    <div class="card">
      <h3>% pass des 5 derniers runs</h3>
      <div *ngIf="loadingRuns" class="skeleton chart"></div>
      <canvas *ngIf="!loadingRuns"
              baseChart
              [data]="lineData"
              [options]="lineOptions"
              chartType="line">
      </canvas>
    </div>

    <div class="card">
      <h3>Taux de succès par outil</h3>
      <canvas baseChart
              [data]="toolBarData"
              [options]="toolBarOptions"
              chartType="bar">
      </canvas>
    </div>

    <div class="card">
      <h3>Par type de test (empilé)</h3>
      <canvas baseChart
              [data]="stackedTypeData"
              [options]="stackedTypeOptions"
              chartType="bar">
      </canvas>
    </div>
  </div>

  <!-- Cartes latérales -->
  <div class="side-cards">
    <div class="card">
      <div class="card-title">Top échecs ({{ days }} j)</div>
      <ol class="list">
        <li *ngFor="let t of topFails"
            (click)="fStatus='failed'; loadAll()"
            class="clickable">
          <strong>{{ t.name }}</strong>
          <span class="muted">({{ t.tool || '—' }})</span>
          <span class="badge fail">{{ t.count }}</span>
        </li>
        <li *ngIf="!topFails?.length" class="muted">Aucun échec récurrent.</li>
      </ol>
    </div>

    <div class="card">
      <div class="card-title">Tests instables ({{ days }} j)</div>
      <ol class="list">
        <li *ngFor="let t of flaky"
            (click)="fStatus='failed'; loadAll()"
            class="clickable">
          <strong>{{ t.name }}</strong>
          <span class="muted">({{ t.tool || '—' }})</span>
          <span class="badge warn">fails: {{ t.count }}</span>
        </li>
        <li *ngIf="!flaky?.length" class="muted">Rien à signaler.</li>
      </ol>
    </div>
  </div>

  <!-- Derniers runs -->
  <h3>Derniers runs</h3>
  <div *ngIf="loadingRuns" class="skeleton row"></div>
  <div *ngIf="!loadingRuns && runs.length === 0" class="muted">Aucun run.</div>
  <ul class="runs" *ngIf="!loadingRuns && runs.length">
    <li *ngFor="let r of runs">
      <span class="dot-status" [class.pass]="r.status==='passed'" [class.fail]="r.status==='failed'"></span>
      <strong>{{ r.runId }}</strong>
      <span class="badge" [class.pass]="r.status==='passed'" [class.fail]="r.status==='failed'">{{ r.status }}</span>
      <span class="muted">
        • {{ (r.passed||0) }}/{{ r.total||0 }} passés
        • {{ asDate(r.createdAt) }}
      </span>
    </li>
  </ul>

  <!-- Derniers cas -->
  <h3>Derniers cas</h3>
  <div *ngIf="loadingCases" class="skeleton table"></div>
  <div *ngIf="!loadingCases && (!casesResp || casesResp.total===0)" class="muted">Aucun cas.</div>

  <div class="table-wrap" *ngIf="!loadingCases && casesResp && casesResp.total">
    <table class="table">
      <thead>
      <tr>
        <th>Run</th><th>Suite</th><th>Type</th><th>Outil</th><th>Nom</th><th>Statut</th><th>Date</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let c of casesResp.items" (click)="openCaseDetail(c)" class="row-click">
        <td>{{ c.runId }}</td>
        <td>{{ c.suite }}</td>
        <td>{{ c.type }}</td>
        <td>{{ c.tool }}</td>
        <td class="ellipsis" [title]="c.name">{{ c.name }}</td>
        <td>
          <span class="badge" [class.pass]="c.status==='passed'" [class.fail]="c.status==='failed'">{{ c.status }}</span>
        </td>
        <td>{{ asDate(c.executedAt) }}</td>
      </tr>
      </tbody>
    </table>

    <div class="pager">
      <button (click)="changePage(-1)" [disabled]="casesResp.page <= 0">◀</button>
      <span>
        Page {{ (casesResp.page + 1) }}
        /
        {{ Math.max(1, Math.ceil(casesResp.total / size)) }}
      </span>
      <button (click)="changePage(1)"
              [disabled]="(casesResp.page + 1) >= Math.ceil(casesResp.total / size)">▶</button>
    </div>
  </div>
</div>
