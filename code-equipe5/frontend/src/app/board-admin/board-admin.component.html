<div class="page">
  <h2>Dashboard – {{ project }}</h2>

  <!-- Filtres -->
  <div class="filters card">
    <div class="row">
      <div class="col">
        <label>Statut</label>
        <select [(ngModel)]="fStatus" (change)="loadAll()">
          <option value="all">Tous</option>
          <option value="passed">Passés</option>
          <option value="failed">Échoués</option>
        </select>
      </div>
      <div class="col">
        <label>Outil</label>
        <select [(ngModel)]="fTool" (change)="loadAll()">
          <option value="all">Tous</option>
          <option value="gatling">Gatling</option>
          <option value="selenium">Selenium</option>
          <option value="restAssured">Rest Assured</option>
          <option value="other">Autre</option>
        </select>
      </div>
      <div class="col">
        <label>Fenêtre</label>
        <div class="segmented">
          <button [class.active]="days===7"  (click)="changeDays(7)">7 j</button>
          <button [class.active]="days===14" (click)="changeDays(14)">14 j</button>
          <button [class.active]="days===30" (click)="changeDays(30)">30 j</button>
          <button [class.active]="days===60" (click)="changeDays(60)">60 j</button>
        </div>
      </div>
      <div class="col right">
        <button class="primary" (click)="loadAll()">Appliquer</button>
      </div>
    </div>
  </div>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi-card total">
      <div class="kpi-title">Total runs ({{ days }} j)</div>
      <div class="kpi-value">{{ totalRuns | number }}</div>
    </div>
    <div class="kpi-card passed">
      <div class="kpi-title">Passés</div>
      <div class="kpi-value">{{ totalPassed | number }}</div>
    </div>
    <div class="kpi-card rate">
      <div class="kpi-title">Passrate global</div>
      <div class="kpi-value">{{ passPct }}%</div>
    </div>
  </div>

  <!-- Charts : rangée 1 (compacte) -->
  <div class="charts">
    <div class="card chart-compact">
      <h3 class="section-title">Répartition (pass/échec)</h3>
      <div *ngIf="loadingRate" class="skeleton chart"></div>
      <canvas *ngIf="!loadingRate" baseChart [data]="pieData" [options]="pieOptions" [type]="'doughnut'"></canvas>
      <div class="legend-inline">
        <span class="dot pass"></span> Passés
        <span class="dot fail"></span> Échoués
      </div>
    </div>

    <div class="card wide chart-compact">
      <h3 class="section-title">Passrate journalier ({{ days }} jours)</h3>
      <div *ngIf="loadingRate" class="skeleton chart"></div>
      <canvas *ngIf="!loadingRate" baseChart [data]="lineData" [options]="lineOptions" [type]="'line'"></canvas>
    </div>
  </div>

  <!-- Charts : rangée 2 -->
  <div class="charts">
    <div class="card">
      <h3 class="section-title">% pass des 5 derniers runs</h3>
      <div *ngIf="loadingRuns" class="skeleton chart"></div>
      <canvas *ngIf="!loadingRuns" baseChart [data]="runsBarData" [options]="runsBarOptions" [type]="'bar'"></canvas>
    </div>

    <div class="card">
      <h3 class="section-title">Taux de succès par outil</h3>
      <div *ngIf="loadingTool" class="skeleton chart"></div>
      <canvas *ngIf="!loadingTool" baseChart [data]="toolBarData" [options]="toolBarOptions" [type]="'bar'"></canvas>
    </div>

    <div class="card">
      <h3 class="section-title">Par type de test (empilé)</h3>
      <div *ngIf="loadingType" class="skeleton chart"></div>
      <canvas *ngIf="!loadingType" baseChart [data]="stackedTypeData" [options]="stackedTypeOptions" [type]="'bar'"></canvas>
    </div>
  </div>


  <!-- Top échecs & Flaky -->
  <div class="two-cols">
    <div class="card">
      <div class="section-title">Top échecs ({{ days }} j)</div>
      <ol class="list top-fails">
        <li *ngFor="let t of topFails" (click)="fStatus='failed'; loadAll()" class="row-click">
          <strong>{{ t.name }}</strong>
          <span class="muted">({{ t.tool || '—' }})</span>
          <span class="badge fail">{{ t.count }}</span>
        </li>
        <li *ngIf="!topFails?.length" class="muted">Aucun échec récurrent.</li>
      </ol>
    </div>

    <div class="card">
      <div class="section-title">Tests instables ({{ days }} j)</div>
      <ol class="list">
        <li *ngFor="let t of flaky" (click)="fStatus='all'; loadAll()" class="row-click">
          <strong>{{ t.name }}</strong>
          <span class="muted">({{ t.tool || '—' }})</span>
          <span class="badge warn">fails: {{ t.count }}</span>
        </li>
        <li *ngIf="!flaky?.length" class="muted">Rien à signaler.</li>
      </ol>
    </div>
  </div>

  <!-- Derniers runs -->
  <h3>Derniers runs</h3>
  <div *ngIf="loadingRuns" class="skeleton row"></div>
  <div *ngIf="!loadingRuns && runs.length === 0" class="muted">Aucun run.</div>
  <ul class="runs" *ngIf="!loadingRuns && runs.length">
    <li *ngFor="let r of runs">
      <span class="dot-status" [class.pass]="r.status==='passed'" [class.fail]="r.status==='failed'"></span>
      <strong>{{ r.runId }}</strong>
      <span class="{{ statusClass(r.status) }}">{{ r.status }}</span>
      <span class="muted">• {{ (r.passed||0) }}/{{ r.total||0 }} passés • {{ asDate(r.createdAt) }}</span>
    </li>
  </ul>

  <!-- Derniers cas -->
  <h3>Derniers cas</h3>
  <div class="table-wrap" *ngIf="!loadingCases && casesResp.total; else noCases">
    <table class="table">
      <thead>
      <tr>
        <th>Run</th><th>Suite</th><th>Type</th><th>Outil</th><th>Nom</th><th>Statut</th><th>Date</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let c of casesResp.items" (click)="openCaseDetail(c)" class="row-click">
        <td>{{ c.runId }}</td>
        <td>{{ c.suite }}</td>
        <td>{{ c.type }}</td>
        <td>{{ c.tool }}</td>
        <td class="ellipsis" [title]="c.name">{{ c.name }}</td>
        <td><span class="{{ statusClass(c.status) }}">{{ c.status }}</span></td>
        <td>{{ asDate(c.executedAt) }}</td>
      </tr>
      </tbody>
    </table>

    <div class="pager">
      <button (click)="changePage(-1)" [disabled]="casesResp.page <= 0">◀</button>
      <span>Page {{ (casesResp.page + 1) }} / {{ Math.max(1, Math.ceil(casesResp.total / size)) }}</span>
      <button (click)="changePage(1)" [disabled]="(casesResp.page + 1) >= Math.ceil(casesResp.total / size)">▶</button>
    </div>
  </div>
  <ng-template #noCases>
    <div *ngIf="loadingCases" class="skeleton table"></div>
    <div *ngIf="!loadingCases" class="muted">Aucun cas.</div>
  </ng-template>
</div>
